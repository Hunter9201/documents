<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Uganda Legal Documents â€” Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CSP that allows GitHub API + raw image previews -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  base-uri 'self';
  frame-ancestors 'none';
  connect-src 'self' https://api.github.com;
  img-src 'self' data: blob: https://raw.githubusercontent.com;
  script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval' blob:;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src https://fonts.gstatic.com;
  upgrade-insecure-requests">

<meta http-equiv="Referrer-Policy" content="no-referrer"/>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--brand:#1a365d;--ok:#16a34a;--bad:#c53030;--card:#fff;--bg:#f7fafc}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:12px 16px;z-index:10}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:2fr 3fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .card .body{padding:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  label{font-weight:700;font-size:14px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px}
  .muted{color:var(--muted)}
  .button{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;font-weight:700;cursor:pointer}
  .primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tag{display:inline-block;background:#1a365d0f;border:1px solid #a7c5e0;color:#1a365d;font-weight:800;padding:3px 8px;border-radius:999px}
  .small{font-size:12px}
  .preview{position:relative;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#f8fafc}
  .preview img{width:100%;height:160px;object-fit:cover;display:block;background:#f1f5f9}
  .rm{position:absolute;top:6px;right:6px;z-index:2}
  .loading{display:flex;align-items:center;justify-content:center;height:160px;color:var(--muted);font-size:14px}
  .list{display:grid;gap:8px}
  .list .item{border:1px dashed var(--line);border-radius:10px;padding:10px}
  .code{white-space:pre-wrap;word-break:break-word;background:#f8fafc;border:1px solid var(--line);padding:10px;border-radius:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;max-height:220px;overflow:auto}
  
  /* Token input modal styles */
  .token-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 16px;
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
  }
  
  .token-modal {
    background: var(--card);
    border-radius: 16px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    border: 1px solid var(--line);
    overflow: hidden;
    max-height: 90vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .token-modal .header {
    padding: 16px;
    border-bottom: 1px solid var(--line);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .token-modal .header h3 {
    margin: 0;
    font-size: 18px;
  }
  
  .token-modal .body {
    padding: 16px;
  }
  
  .token-modal .footer {
    padding: 16px;
    border-top: 1px solid var(--line);
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  
  .token-modal textarea {
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size: 14px;
    min-height: 100px;
    resize: vertical;
  }
  
  .token-info {
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
    padding: 10px;
    margin-bottom: 12px;
    font-size: 12px;
    color: #0369a1;
  }
  
  .categories-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-top: 8px;
  }
  
  .category-option {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .category-option input {
    width: auto;
  }
  
  .stat-badge {
    display: inline-block;
    background: #1a365d;
    color: white;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 6px;
  }
  
  /* PDF upload styles */
  .upload-area {
    border: 2px dashed var(--line);
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    margin: 12px 0;
    background: #f8fafc;
    cursor: pointer;
    transition: border-color 0.2s;
  }
  
  .upload-area:hover {
    border-color: var(--brand);
  }
  
  .upload-area.dragover {
    border-color: var(--ok);
    background: #f0fdf4;
  }
  
  .upload-icon {
    font-size: 36px;
    color: var(--muted);
    margin-bottom: 8px;
  }
  
  .files-preview {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 16px;
  }
  
  .file-card {
    border: 1px solid var(--line);
    border-radius: 8px;
    padding: 12px;
    background: #fff;
  }
  
  .file-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
  }
  
  .file-name {
    font-weight: 600;
    font-size: 14px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    margin-right: 8px;
  }
  
  .file-size {
    font-size: 12px;
    color: var(--muted);
  }
  
  .file-info {
    font-size: 12px;
    color: var(--muted);
    line-height: 1.4;
  }
  
  .progress-bar {
    height: 4px;
    background: var(--line);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: var(--ok);
    width: 0%;
    transition: width 0.3s;
  }
  
  @media (max-width:900px){ 
    .grid{grid-template-columns:1fr}
    .files-preview{grid-template-columns:1fr}
  }
  @media (max-width:768px){ 
    .row{grid-template-columns:1fr}
    .categories-grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px">
    <strong>Uganda Legal Documents â€” Admin Panel</strong>
    <div class="bar">
      <button id="setTokenBtn" class="button">Set GitHub Token</button>
      <button id="setSessionBtn" class="button">Use Session</button>
      <button id="clearTokenBtn" class="button bad">Clear Token</button>
      <span id="tokenState" class="tag">No token</span>
    </div>
  </div>
</header>

<!-- Token Input Modal -->
<div id="tokenModal" class="token-modal-overlay">
  <div class="token-modal">
    <div class="header">
      <h3>Set GitHub Token</h3>
      <button id="closeTokenModal" class="button" style="font-size: 20px; padding: 4px 10px;">Ã—</button>
    </div>
    <div class="body">
      <div class="token-info">
        <strong>GitHub Personal Access Token Required</strong><br>
        Create a fine-grained token with read/write permissions for this repository. The token will be stored locally in your browser.
      </div>
      <label for="tokenInput">Paste your GitHub token:</label>
      <textarea id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
      <div class="muted small" style="margin-top: 6px;">
        â€¢ Token is saved locally (or in session if enabled)<br>
        â€¢ Never share your token with anyone
      </div>
    </div>
    <div class="footer">
      <button id="cancelTokenBtn" class="button">Cancel</button>
      <button id="saveTokenBtn" class="button primary">Save Token</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- CONFIG -->
  <div class="card" style="margin-bottom:12px">
    <div class="body">
      <h3 style="margin:0 0 8px">CONFIGURATION â€“ EDIT THESE VALUES</h3>
      <div class="row">
        <div><label>GitHub Owner</label><input id="cfgOwner" placeholder="e.g., your-username"></div>
        <div><label>GitHub Repository</label><input id="cfgRepo" placeholder="e.g., uganda-legal-docs"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label>Branch</label><input id="cfgBranch" placeholder="main"></div>
        <div><label>Documents JSON path</label><input id="cfgDocuments" placeholder="documents.json"></div>
      </div>
      <div class="muted small" style="margin-top:6px">Values are saved locally (or in session mode if enabled).</div>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: FORM -->
    <div class="card">
      <div class="body">
        <h2 id="formTitle" style="margin:0 0 10px">Upload Legal Documents <span id="editBadge" class="tag" style="display:none">Editing</span></h2>
        
        <div style="margin-bottom:12px">
          <label>Category</label>
          <div class="categories-grid">
            <div class="category-option"><input type="radio" name="category" value="constitutional" checked> Constitutional Law</div>
            <div class="category-option"><input type="radio" name="category" value="criminal"> Criminal Law</div>
            <div class="category-option"><input type="radio" name="category" value="civil"> Civil Law</div>
            <div class="category-option"><input type="radio" name="category" value="commercial"> Commercial Law</div>
            <div class="category-option"><input type="radio" name="category" value="family"> Family Law</div>
            <div class="category-option"><input type="radio" name="category" value="property"> Property Law</div>
            <div class="category-option"><input type="radio" name="category" value="evidence"> Evidence Law</div>
            <div class="category-option"><input type="radio" name="category" value="procedure"> Procedure</div>
            <div class="category-option"><input type="radio" name="category" value="judicature"> Judicature</div>
            <div class="category-option"><input type="radio" name="category" value="magistrate"> Magistrate Courts</div>
            <div class="category-option"><input type="radio" name="category" value="administrative"> Administrative Law</div>
            <div class="category-option"><input type="radio" name="category" value="employment"> Employment Law</div>
            <div class="category-option"><input type="radio" name="category" value="international"> International Law</div>
            <div class="category-option"><input type="radio" name="category" value="other"> Other Acts</div>
          </div>
        </div>

        <!-- PDF Upload Area -->
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">ðŸ“„</div>
          <div><strong>Click to select PDF files or drag & drop here</strong></div>
          <div class="muted small">Upload up to 4 PDF documents at once (Max 50MB each)</div>
          <input type="file" id="pdfInput" accept=".pdf" multiple style="display:none">
        </div>

        <!-- Files Preview -->
        <div id="filesPreview" class="files-preview"></div>

        <!-- Auto-extracted info -->
        <div id="autoInfo" style="margin-top:16px; display:none;">
          <h4 style="margin:0 0 8px">Auto-extracted Information</h4>
          <div class="muted small">
            Document titles will be extracted from filenames. Year and other details will be auto-generated.
          </div>
        </div>

        <div class="bar" style="margin-top:14px">
          <button id="publishBtn" class="button primary" type="button">Upload to GitHub</button>
          <button id="updateBtn" class="button ok" type="button" style="display:none">Update Document</button>
          <button id="resetBtn" class="button" type="button">Clear All</button>
        </div>
        <div id="status" class="muted small" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- RIGHT: MANAGE -->
    <div class="card">
      <div class="body">
        <h3 style="margin:0 0 10px">Manage Legal Documents (GitHub)<span class="stat-badge" id="docCount">0</span></h3>
        <div class="bar" style="margin-bottom:8px">
          <button id="refreshBtn" class="button" type="button">Refresh List</button>
          <span style="flex:1"></span>
          <button id="exportBtn" class="button" type="button">Export JSON</button>
          <button id="importBtn" class="button" type="button">Import JSON</button>
          <input id="importInput" type="file" accept="application/json" style="display:none">
        </div>
        <div id="docList" class="list"></div>

        <h3 style="margin:16px 0 10px">Last Action</h3>
        <div id="preview" class="list"></div>

        <h4 style="margin:14px 0 6px">Activity Log</h4>
        <div id="log" class="code"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===========================
   Uganda Legal Documents Admin Panel
   =========================== */

/* --- STORAGE KEYS --- */
const TOKEN_KEY = "UGANDA_LEGAL_GH_TOKEN_V1";
const CFG_KEY   = "UGANDA_LEGAL_ADMIN_CFG_V1";
const SESSION_ONLY_KEY = "UGANDA_LEGAL_SESSION_ONLY";

/* --- DEFAULT CONFIG --- */
const defaultCfg = {
  owner: "your-username",
  repo: "uganda-legal-docs",
  branch: "main",
  documentsPath: "documents.json"
};

/* --- CATEGORY MAPPING --- */
const categoryNames = {
    constitutional: "Constitutional Law",
    criminal: "Criminal Law",
    civil: "Civil Law",
    commercial: "Commercial Law",
    family: "Family Law",
    property: "Property Law",
    evidence: "Evidence Law",
    procedure: "Procedure",
    judicature: "Judicature",
    magistrate: "Magistrate Courts",
    administrative: "Administrative Law",
    employment: "Employment Law",
    international: "International Law",
    other: "Other Acts"
};

/* --- DOM REFS --- */
const tokenState = document.getElementById('tokenState');
const setTokenBtn = document.getElementById('setTokenBtn');
const setSessionBtn = document.getElementById('setSessionBtn');
const clearTokenBtn = document.getElementById('clearTokenBtn');
const docCount = document.getElementById('docCount');

// Token modal elements
const tokenModal = document.getElementById('tokenModal');
const tokenInput = document.getElementById('tokenInput');
const closeTokenModal = document.getElementById('closeTokenModal');
const cancelTokenBtn = document.getElementById('cancelTokenBtn');
const saveTokenBtn = document.getElementById('saveTokenBtn');

const cfgOwner = document.getElementById('cfgOwner');
const cfgRepo = document.getElementById('cfgRepo');
const cfgBranch = document.getElementById('cfgBranch');
const cfgDocuments = document.getElementById('cfgDocuments');

const publishBtn = document.getElementById('publishBtn');
const updateBtn = document.getElementById('updateBtn');
const resetBtn = document.getElementById('resetBtn');
const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const previewEl = document.getElementById('preview');

const refreshBtn = document.getElementById('refreshBtn');
const docList = document.getElementById('docList');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importInput = document.getElementById('importInput');

const formTitle = document.getElementById('formTitle');
const editBadge = document.getElementById('editBadge');

// Upload elements
const uploadArea = document.getElementById('uploadArea');
const pdfInput = document.getElementById('pdfInput');
const filesPreview = document.getElementById('filesPreview');
const autoInfo = document.getElementById('autoInfo');

/* --- STATE --- */
let editingId = null; // id being edited
let selectedFiles = []; // Array of {file, title, year, size, pages}

/* --- HELPERS --- */
const API_BASE = "https://api.github.com";

function log(msg){ 
  const timestamp = new Date().toLocaleTimeString();
  logEl.textContent += `[${timestamp}] ${msg}\n`; 
  logEl.scrollTop = logEl.scrollHeight; 
}

function setStatus(msg){ statusEl.textContent = msg; }

function useSession(){ return sessionStorage.getItem(SESSION_ONLY_KEY) === '1'; }
function storage(){ return useSession() ? sessionStorage : localStorage; }
function saveCfg(cfg){ storage().setItem(CFG_KEY, JSON.stringify(cfg)); }
function loadCfg(){ try{ return {...defaultCfg, ...JSON.parse(storage().getItem(CFG_KEY)||"{}")}; }catch{ return {...defaultCfg}; } }
function setToken(tok){ storage().setItem(TOKEN_KEY, tok); tokenOk(); }
function getToken(){ return storage().getItem(TOKEN_KEY) || ""; }

function tokenOk(stateText){
  const t = getToken();
  tokenState.textContent = stateText || (t ? (useSession()? "Token (session)":"Token set") : "No token");
  tokenState.style.background = t ? "#dcfce7" : "#1a365d0f";
}

function currentCfg(){
  return {
    owner: (cfgOwner?.value || defaultCfg.owner).trim(),
    repo: (cfgRepo?.value || defaultCfg.repo).trim(),
    branch: (cfgBranch?.value || defaultCfg.branch).trim(),
    documentsPath: (cfgDocuments?.value || defaultCfg.documentsPath).trim()
  };
}

function slugify(s){ 
  return String(s||"").toLowerCase()
    .replace(/[^a-z0-9]+/g,"-")
    .replace(/^-+|-+$/g,"")
    .slice(0,50) || "document"; 
}

function toBase64Utf8(str){ return btoa(unescape(encodeURIComponent(str))); }
function fromBase64Utf8(b64){ return decodeURIComponent(escape(atob(b64.replace(/\n/g,'')))); }

function ghHeaders(){
  const h = {
    "Accept": "application/vnd.github+json",
    "X-GitHub-Api-Version": "2022-11-28"
  };
  const t = getToken();
  if (t) h["Authorization"] = "Bearer " + t;
  return h;
}

/* --- PDF FILENAME PARSING --- */
function extractDocumentInfoFromFilename(filename) {
  // Common patterns in Uganda legal document names
  const patterns = [
    // Pattern: "Administration_General_Act_Cap_264.pdf"
    /^(.+?)_(Act|ACT|act)_(Cap|CAP|cap)_(\d+)/i,
    // Pattern: "Uganda_Penal_Code_Act_Cap_120.pdf"
    /^(.+?)_(Code|CODE|code)_(Act|ACT|act)_(Cap|CAP|cap)_(\d+)/i,
    // Pattern: "Evidence_Act_Cap_43.pdf"
    /^(.+?)_(Act|ACT|act)_(Cap|CAP|cap)_(\d+)/i,
    // Pattern: "The_Companies_Act_2012.pdf" or "Companies_Act_2012.pdf"
    /^(.+?)_(Act|ACT|act)_(\d{4})/i,
    // Pattern: "Contract_Act_2010_No_7.pdf"
    /^(.+?)_(Act|ACT|act)_(\d{4})_.+/i,
    // Pattern: "Administration_General_Act.pdf"
    /^(.+?)_(Act|ACT|act)/i
  ];

  // Remove .pdf extension
  const nameWithoutExt = filename.replace(/\.pdf$/i, '');
  
  let title = nameWithoutExt;
  let year = new Date().getFullYear();
  let actNumber = null;

  // Try to match patterns
  for (const pattern of patterns) {
    const match = nameWithoutExt.match(pattern);
    if (match) {
      // Extract title parts
      const parts = nameWithoutExt.split('_');
      
      // Create readable title (replace underscores with spaces, capitalize first letters)
      title = parts.map(part => {
        if (['Act', 'Cap', 'No', 'The'].includes(part) || /^\d+$/.test(part)) {
          return part.toUpperCase();
        }
        return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
      }).join(' ');
      
      // Try to extract year from filename (look for 4-digit numbers)
      const yearMatch = nameWithoutExt.match(/(\d{4})/);
      if (yearMatch) {
        year = parseInt(yearMatch[1]);
      }
      
      // Try to extract Act/Cap number
      const numberMatch = nameWithoutExt.match(/(?:Cap|CAP|cap|No|NO|no)[_\s]*(\d+)/i);
      if (numberMatch) {
        actNumber = numberMatch[1];
      }
      
      break;
    }
  }

  // If no pattern matched, create a nice title from filename
  if (title === nameWithoutExt) {
    title = nameWithoutExt.split('_')
      .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
      .join(' ');
  }

  // Extract category from filename keywords
  let category = 'other';
  const lowerTitle = title.toLowerCase();
  
  if (lowerTitle.includes('constitution') || lowerTitle.includes('constitutional')) {
    category = 'constitutional';
  } else if (lowerTitle.includes('penal') || lowerTitle.includes('criminal')) {
    category = 'criminal';
  } else if (lowerTitle.includes('civil') || lowerTitle.includes('tort')) {
    category = 'civil';
  } else if (lowerTitle.includes('company') || lowerTitle.includes('commercial') || lowerTitle.includes('contract')) {
    category = 'commercial';
  } else if (lowerTitle.includes('family') || lowerTitle.includes('marriage') || lowerTitle.includes('divorce')) {
    category = 'family';
  } else if (lowerTitle.includes('property') || lowerTitle.includes('land')) {
    category = 'property';
  } else if (lowerTitle.includes('evidence')) {
    category = 'evidence';
  } else if (lowerTitle.includes('procedure') || lowerTitle.includes('procedural')) {
    category = 'procedure';
  }

  return {
    title: title,
    year: year,
    category: category,
    actNumber: actNumber
  };
}

/* --- FILE UPLOAD HANDLING --- */
function readFileAsArrayBuffer(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

async function getPDFPageCount(file) {
  try {
    // Try to use PDF.js to get page count
    if (typeof pdfjsLib === 'undefined') {
      // Load PDF.js dynamically
      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    const arrayBuffer = await readFileAsArrayBuffer(file);
    const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
    const pdf = await loadingTask.promise;
    return pdf.numPages;
  } catch (error) {
    console.warn('Could not get PDF page count:', error);
    // Estimate pages based on file size (rough estimate: 50KB per page)
    const estimatedPages = Math.max(1, Math.round(file.size / (50 * 1024)));
    return estimatedPages;
  }
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function updateFilesPreview() {
  filesPreview.innerHTML = '';
  
  if (selectedFiles.length === 0) {
    autoInfo.style.display = 'none';
    return;
  }
  
  autoInfo.style.display = 'block';
  
  selectedFiles.forEach((fileData, index) => {
    const file = fileData.file;
    const info = extractDocumentInfoFromFilename(file.name);
    
    const card = document.createElement('div');
    card.className = 'file-card';
    card.innerHTML = `
      <div class="file-header">
        <div class="file-name" title="${file.name}">${file.name}</div>
        <div class="file-size">${formatFileSize(file.size)}</div>
      </div>
      <div class="file-info">
        <div><strong>Title:</strong> ${info.title}</div>
        <div><strong>Year:</strong> ${info.year}</div>
        <div><strong>Category:</strong> ${categoryNames[info.category] || info.category}</div>
        ${info.actNumber ? `<div><strong>Act/Cap:</strong> ${info.actNumber}</div>` : ''}
        <div><strong>Pages:</strong> Estimating...</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress-${index}"></div>
      </div>
    `;
    
    filesPreview.appendChild(card);
    
    // Get page count asynchronously
    getPDFPageCount(file).then(pages => {
      fileData.pages = pages;
      fileData.title = info.title;
      fileData.year = info.year;
      fileData.category = info.category;
      fileData.size = (file.size / (1024 * 1024)).toFixed(2); // MB
      
      const pageElement = card.querySelector('.file-info div:nth-child(4)');
      if (pageElement) {
        pageElement.innerHTML = `<strong>Pages:</strong> ${pages}`;
      }
    }).catch(error => {
      console.error('Error getting page count:', error);
      fileData.pages = Math.max(1, Math.round(file.size / (50 * 1024)));
      fileData.title = info.title;
      fileData.year = info.year;
      fileData.category = info.category;
      fileData.size = (file.size / (1024 * 1024)).toFixed(2);
      
      const pageElement = card.querySelector('.file-info div:nth-child(4)');
      if (pageElement) {
        pageElement.innerHTML = `<strong>Pages:</strong> ${fileData.pages} (estimated)`;
      }
    });
  });
}

function handleFileSelect(files) {
  // Clear existing files
  selectedFiles = [];
  
  // Get selected category
  const categoryRadios = document.querySelectorAll('input[name="category"]');
  let selectedCategory = 'constitutional';
  categoryRadios.forEach(radio => {
    if (radio.checked) selectedCategory = radio.value;
  });
  
  // Process up to 4 files
  const fileArray = Array.from(files).slice(0, 4);
  
  fileArray.forEach(file => {
    if (file.type === 'application/pdf') {
      if (file.size > 50 * 1024 * 1024) { // 50MB limit
        alert(`File "${file.name}" is too large. Maximum size is 50MB.`);
        return;
      }
      
      const info = extractDocumentInfoFromFilename(file.name);
      selectedFiles.push({
        file: file,
        title: info.title,
        year: info.year,
        category: selectedCategory, // Use selected category from form
        pages: 0, // Will be updated async
        size: (file.size / (1024 * 1024)).toFixed(2)
      });
    } else {
      alert(`"${file.name}" is not a PDF file. Only PDF files are allowed.`);
    }
  });
  
  updateFilesPreview();
  
  if (selectedFiles.length > 0) {
    setStatus(`Ready to upload ${selectedFiles.length} PDF file(s)`);
  }
}

/* --- TOKEN MODAL FUNCTIONS --- */
function showTokenModal() {
  tokenModal.style.display = 'flex';
  tokenInput.value = '';
  setTimeout(() => {
    tokenInput.focus();
    tokenModal.scrollTop = 0;
  }, 100);
}

function hideTokenModal() {
  tokenModal.style.display = 'none';
  tokenInput.value = '';
}

async function saveTokenFromModal() {
  const token = tokenInput.value.trim();
  if (!token) {
    alert("Please enter a GitHub token.");
    return;
  }
  
  setToken(token);
  hideTokenModal();
  
  setStatus("Testing tokenâ€¦");
  const ok = await verifyTokenAccess();
  setStatus(ok ? "Token OK" : "Token invalid for repo");
}

/* GitHub API */
async function ghGetContents(path, cfg=currentCfg()){
  const url = `${API_BASE}/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(cfg.branch)}`;
  const r = await fetch(url, {headers: ghHeaders()});
  if (r.status === 404) return {status:404};
  if (!r.ok) throw new Error(`GET ${path} failed: ${r.status} ${await r.text()}`);
  return await r.json();
}

async function ghPutContents(path, base64Content, message, sha=null, cfg=currentCfg()){
  const url = `${API_BASE}/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
  const body = { message, content: base64Content, branch: cfg.branch };
  if (sha) body.sha = sha;
  const r = await fetch(url, { method: "PUT", headers: {...ghHeaders(), "Content-Type":"application/json"}, body: JSON.stringify(body) });
  if (!r.ok) throw new Error(`PUT ${path} failed: ${r.status} ${await r.text()}`);
  return await r.json();
}

async function uploadPDFFile(file, filename, message, cfg=currentCfg()) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const base64 = btoa(new Uint8Array(reader.result).reduce((data, byte) => data + String.fromCharCode(byte), ''));
        const result = await ghPutContents(filename, base64, message, null, cfg);
        resolve(result);
      } catch (error) {
        reject(error);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

async function ghDeleteContents(path, message, sha, cfg=currentCfg()){
  const url = `${API_BASE}/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
  const r = await fetch(url, { method: "DELETE", headers: {...ghHeaders(), "Content-Type":"application/json"}, body: JSON.stringify({ message, sha, branch: cfg.branch }) });
  if (!r.ok) throw new Error(`DELETE ${path} failed: ${r.status} ${await r.text()}`);
  return await r.json();
}

/* Token quick test */
async function verifyTokenAccess(){
  try{
    const cfg = currentCfg();
    const r = await fetch(`${API_BASE}/repos/${cfg.owner}/${cfg.repo}`, {headers: ghHeaders()});
    if (!r.ok) { tokenOk("Token invalid for repo"); return false; }
    tokenOk("Token OK");
    return true;
  }catch{
    tokenOk("Token check failed");
    return false;
  }
}

/* Documents.json */
async function loadDocumentsJson(){
  const got = await ghGetContents(currentCfg().documentsPath);
  if (got.status === 404) return { arr: [], sha: null };
  const sha = got.sha;
  const text = fromBase64Utf8(got.content);
  let arr = [];
  try{ arr = JSON.parse(text); if(!Array.isArray(arr)) arr=[]; }catch{ arr=[]; }
  return { arr, sha };
}

function renderDocumentsAdmin(arr){
  if (!Array.isArray(arr) || !arr.length){
    docList.innerHTML = '<div class="muted small">No documents found in documents.json.</div>';
    docCount.textContent = '0';
    return;
  }
  
  docCount.textContent = arr.length;
  docList.replaceChildren();
  
  arr.forEach(doc=>{
    const item = document.createElement('div'); 
    item.className='item'; 
    item.dataset.id=doc.id;
    
    const top = document.createElement('div'); 
    top.className='bar'; 
    top.style.justifyContent='space-between'; 
    top.style.alignItems='flex-start';
    top.style.marginBottom='6px';

    const left = document.createElement('div');
    const name = document.createElement('div');
    const strong = document.createElement('strong'); 
    strong.textContent = doc.title;
    const smallId = document.createElement('span'); 
    smallId.className='muted small'; 
    smallId.textContent = ` (ID: ${doc.id})`;
    name.appendChild(strong); 
    name.appendChild(smallId);
    
    const meta = document.createElement('div'); 
    meta.className='muted small'; 
    meta.textContent = `Category: ${categoryNames[doc.category]||doc.category} â€¢ Year: ${doc.year} â€¢ Size: ${doc.size}MB â€¢ Pages: ${doc.pages}`;
    
    const desc = document.createElement('div'); 
    desc.className='muted small'; 
    desc.textContent = (doc.description||'').slice(0,140);
    
    left.appendChild(name); 
    left.appendChild(meta); 
    left.appendChild(desc);

    const right = document.createElement('div'); 
    right.className='bar';
    
    const editBtn = document.createElement('button'); 
    editBtn.className='button ok'; 
    editBtn.textContent='Edit'; 
    editBtn.onclick=()=>startEdit(doc);
    
    const delBtn = document.createElement('button'); 
    delBtn.className='button bad'; 
    delBtn.textContent='Delete'; 
    delBtn.onclick=()=>deleteDocument(doc.id);
    
    right.appendChild(editBtn); 
    right.appendChild(delBtn);

    top.appendChild(left); 
    top.appendChild(right);
    item.appendChild(top);
    
    const filenameDiv = document.createElement('div'); 
    filenameDiv.className='muted small'; 
    filenameDiv.style.marginTop='4px';
    filenameDiv.textContent = `Filename: ${doc.filename}`;
    item.appendChild(filenameDiv);
    
    docList.appendChild(item);
  });
}

/* Editing */
function startEdit(doc){
  editingId = doc.id; 
  formTitle.textContent='Edit Document'; 
  editBadge.style.display='inline-block';
  publishBtn.style.display='none'; 
  updateBtn.style.display='inline-block';
  
  // Clear file selection when editing
  selectedFiles = [];
  updateFilesPreview();
  
  // Show editing form with existing data
  const editForm = document.createElement('div');
  editForm.innerHTML = `
    <div style="margin-top:16px; background:#f0f9ff; padding:12px; border-radius:8px;">
      <h4>Edit Document Details</h4>
      <div class="row">
        <div><label>Document Title</label><input id="editTitle" value="${doc.title || ''}"></div>
        <div><label>Year</label><input id="editYear" type="number" value="${doc.year || new Date().getFullYear()}"></div>
      </div>
      <div style="margin-top:8px">
        <label>Description</label>
        <textarea id="editDesc" rows="2">${doc.description || ''}</textarea>
      </div>
    </div>
  `;
  
  // Replace the upload section with edit form
  uploadArea.style.display = 'none';
  autoInfo.style.display = 'none';
  filesPreview.innerHTML = '';
  filesPreview.appendChild(editForm);
  
  window.scrollTo({top:0, behavior:'smooth'});
}

function resetForm(){
  editingId=null; 
  formTitle.textContent='Upload Legal Documents'; 
  editBadge.style.display='none';
  publishBtn.style.display='inline-block'; 
  updateBtn.style.display='none';
  
  // Reset category to constitutional
  const constitutionalRadio = document.querySelector('input[name="category"][value="constitutional"]');
  if (constitutionalRadio) constitutionalRadio.checked = true;
  
  // Clear files
  selectedFiles = [];
  updateFilesPreview();
  uploadArea.style.display = 'block';
  
  setStatus('');
}

resetBtn.addEventListener('click', resetForm);

/* Publish (Create) - UPDATED FOR MULTIPLE FILES */
publishBtn.addEventListener('click', async ()=>{
  try{
    if (!getToken()){ alert("Set your GitHub token first."); return; }
    if (selectedFiles.length === 0){ alert("Please select PDF files to upload."); return; }

    // verify token once
    const ok = await verifyTokenAccess(); 
    if (!ok){ alert("Token not authorized for this repo."); return; }

    const cfg = currentCfg();
    setStatus("Starting upload processâ€¦"); 
    log("=== Starting document upload ===");
    
    // Get selected category
    const categoryRadios = document.querySelectorAll('input[name="category"]');
    let selectedCategory = 'constitutional';
    categoryRadios.forEach(radio => {
      if (radio.checked) selectedCategory = radio.value;
    });

    setStatus("Loading existing documentsâ€¦");
    let arr = []; 
    let sha = null;
    const got = await ghGetContents(cfg.documentsPath, cfg);
    if (got.status !== 404){ 
      sha = got.sha; 
      try{ 
        arr = JSON.parse(fromBase64Utf8(got.content)); 
        if(!Array.isArray(arr)) arr=[]; 
      }catch{ arr=[]; } 
      log(`Loaded ${arr.length} existing documents`); 
    }

    // Generate new IDs
    let nextId = arr.length > 0 ? Math.max(...arr.map(d => d.id)) + 1 : 1;
    
    const newDocuments = [];
    const uploadedFiles = [];
    
    // Process each file
    for (let i = 0; i < selectedFiles.length; i++) {
      const fileData = selectedFiles[i];
      const file = fileData.file;
      
      // Update progress
      const progressBar = document.getElementById(`progress-${i}`);
      if (progressBar) {
        progressBar.style.width = '30%';
      }
      
      setStatus(`Uploading ${file.name} (${i+1}/${selectedFiles.length})â€¦`);
      log(`Uploading PDF: ${file.name}`);
      
      try {
        // Upload PDF file to GitHub
        const uploadResult = await uploadPDFFile(
          file,
          file.name,
          `Add PDF: ${fileData.title}`,
          cfg
        );
        
        uploadedFiles.push({
          filename: file.name,
          title: fileData.title,
          url: uploadResult.content.html_url
        });
        
        if (progressBar) {
          progressBar.style.width = '60%';
        }
        
        // Create document entry
        const document = { 
          id: nextId++,
          title: fileData.title,
          description: `Legal document: ${fileData.title}. Uploaded on ${new Date().toLocaleDateString()}.`,
          filename: file.name,
          category: selectedCategory,
          size: fileData.size,
          pages: fileData.pages,
          date: new Date().toISOString().split('T')[0],
          updated: false,
          year: fileData.year
        };
        
        newDocuments.push(document);
        
        if (progressBar) {
          progressBar.style.width = '90%';
        }
        
        log(`âœ“ Uploaded: ${file.name}`);
      } catch (error) {
        log(`âœ— Failed to upload ${file.name}: ${error.message}`);
        alert(`Failed to upload ${file.name}. Please try again.`);
        if (progressBar) {
          progressBar.style.width = '0%';
        }
        return;
      }
    }
    
    // Add all new documents to array
    arr.push(...newDocuments);
    
    setStatus("Updating documents.jsonâ€¦");
    
    // Update documents.json
    await ghPutContents(
      cfg.documentsPath, 
      toBase64Utf8(JSON.stringify(arr,null,2)), 
      `Add ${newDocuments.length} document(s): ${newDocuments.map(d => d.title).join(', ')}`, 
      sha||undefined, 
      cfg
    );
    
    log(`âœ“ documents.json updated with ${newDocuments.length} new document(s)`);
    
    // Complete progress bars
    selectedFiles.forEach((_, i) => {
      const progressBar = document.getElementById(`progress-${i}`);
      if (progressBar) {
        progressBar.style.width = '100%';
      }
    });
    
    setStatus(`Successfully uploaded ${newDocuments.length} document(s)!`);
    
    // Show preview
    previewEl.innerHTML = '';
    newDocuments.forEach(doc => {
      const it = document.createElement('div'); 
      it.className='item';
      it.innerHTML = `
        <div><strong>${doc.title}</strong> â€” ${categoryNames[doc.category]||doc.category}</div>
        <div class="muted small">${doc.description||''}</div>
        <div class="muted small">Filename: ${doc.filename} â€¢ Size: ${doc.size}MB â€¢ Pages: ${doc.pages}</div>
      `;
      previewEl.appendChild(it);
    });

    alert(`Successfully uploaded ${newDocuments.length} document(s)!`);
    await refreshDocumentsList();
    resetForm();
  }catch(err){ 
    console.error(err); 
    log(String(err)); 
    setStatus("Error: " + err.message); 
    alert("Upload failed:\n" + err.message); 
  }
});

/* Update (Edit) - Updated for file editing */
updateBtn.addEventListener('click', async ()=>{
  try{
    if (!editingId){ alert('Nothing to update.'); return; }
    if (!getToken()){ alert("Set your GitHub token first."); return; }
    if (!(await verifyTokenAccess())){ alert("Token not authorized for this repo."); return; }
    
    const title = document.getElementById('editTitle')?.value?.trim();
    const year = document.getElementById('editYear')?.value;
    const description = document.getElementById('editDesc')?.value?.trim();
    
    if (!title){ alert("Enter document title."); return; }

    const cfg = currentCfg();
    setStatus("Updating documentâ€¦"); 
    log(`=== Updating document: ${editingId} ===`);
    
    const { arr, sha } = await loadDocumentsJson();
    const idx = arr.findIndex(x=>x.id === editingId);
    if (idx === -1){ alert('Document not found.'); return; }

    // Get selected category
    const categoryRadios = document.querySelectorAll('input[name="category"]');
    let selectedCategory = 'constitutional';
    categoryRadios.forEach(radio => {
      if (radio.checked) selectedCategory = radio.value;
    });

    const updated = { 
      ...arr[idx], 
      title: title,
      description: description || arr[idx].description,
      category: selectedCategory,
      year: parseInt(year) || arr[idx].year,
      updated: true
    };
    
    arr[idx] = updated;
    
    await ghPutContents(
      cfg.documentsPath, 
      toBase64Utf8(JSON.stringify(arr,null,2)), 
      `Update document: ${updated.title}`, 
      sha||undefined, 
      cfg
    );
    
    log("âœ“ documents.json updated on GitHub");
    setStatus('Updated.');
    log('documents.json updated.');
    
    // Show preview
    previewEl.innerHTML = '';
    const it = document.createElement('div'); 
    it.className='item';
    it.innerHTML = `
      <div><strong>${updated.title}</strong> â€” ${categoryNames[updated.category]||updated.category}</div>
      <div class="muted small">${updated.description||''}</div>
      <div class="muted small">Filename: ${updated.filename} â€¢ Size: ${updated.size}MB â€¢ Pages: ${updated.pages}</div>
    `;
    previewEl.appendChild(it);

    await refreshDocumentsList();
    resetForm();
  }catch(err){ 
    console.error(err); 
    log(String(err)); 
    setStatus("Error: " + err.message); 
    alert("Update failed:\n" + err.message); 
  }
});

/* Delete */
async function deleteDocument(docId){
  try{
    if (!getToken()){ alert("Set your GitHub token first."); return; }
    if (!confirm(`Delete document ID "${docId}"? This cannot be undone.\n\nNote: This only removes the entry from documents.json. The PDF file must be deleted manually from the repository.`)) return;
    if (!(await verifyTokenAccess())){ alert("Token not authorized for this repo."); return; }

    setStatus("Deletingâ€¦"); 
    log(`=== Deleting document: ${docId} ===`);
    
    const cfg = currentCfg();
    const { arr, sha } = await loadDocumentsJson();
    const idx = arr.findIndex(p => p.id === docId);
    if (idx === -1){ alert("Document not found."); return; }
    
    const docToDelete = arr[idx];
    
    const newArr = arr.filter(p => p.id !== docId);
    await ghPutContents(
      cfg.documentsPath, 
      toBase64Utf8(JSON.stringify(newArr,null,2)), 
      `Delete document: ${docToDelete.title}`, 
      sha||undefined, 
      cfg
    );
    
    log(`âœ“ Removed document ID ${docId} from documents.json`);
    setStatus("Deleted.");
    
    await refreshDocumentsList();
  }catch(err){ 
    console.error(err); 
    log(String(err)); 
    setStatus("Error: " + err.message); 
    alert("Delete failed:\n" + err.message); 
  }
}

/* List / Export / Import */
async function refreshDocumentsList(){
  try{
    setStatus("Loading documents from GitHubâ€¦");
    const { arr } = await loadDocumentsJson();
    renderDocumentsAdmin(arr);
    setStatus("Ready.");
  }catch(err){
    log("Load list error: " + err.message);
    setStatus("Error loading list.");
  }
}

exportBtn.addEventListener('click', async ()=>{
  try{
    const { arr } = await loadDocumentsJson();
    const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); 
    a.download = 'uganda-legal-documents-export.json'; 
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(err){ alert('Export failed: '+err.message); }
});

importBtn.addEventListener('click', ()=> importInput.click());

importInput.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  if(!confirm('This will replace documents.json in the repo. Continue?')) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    if(!Array.isArray(data)) throw new Error('JSON must be an array');
    
    // Validate document structure
    const requiredFields = ['id', 'title', 'filename', 'category'];
    data.forEach((doc, idx) => {
      requiredFields.forEach(field => {
        if (!doc.hasOwnProperty(field)) {
          throw new Error(`Document at index ${idx} missing required field: ${field}`);
        }
      });
    });
    
    const { sha } = await loadDocumentsJson();
    await ghPutContents(
      currentCfg().documentsPath, 
      toBase64Utf8(JSON.stringify(data,null,2)), 
      `Import documents.json`, 
      sha||undefined, 
      currentCfg()
    );
    
    alert('Imported successfully.');
    await refreshDocumentsList();
    importInput.value = '';
  }catch(err){ 
    alert('Import failed: '+err.message); 
    importInput.value = '';
  }
});

/* File upload event listeners */
uploadArea.addEventListener('click', () => {
  pdfInput.click();
});

pdfInput.addEventListener('change', (e) => {
  if (e.target.files.length > 4) {
    alert('Maximum 4 files allowed. Only the first 4 will be processed.');
  }
  handleFileSelect(e.target.files);
});

// Drag and drop support
uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  
  if (e.dataTransfer.files.length > 0) {
    if (e.dataTransfer.files.length > 4) {
      alert('Maximum 4 files allowed. Only the first 4 will be processed.');
    }
    handleFileSelect(e.dataTransfer.files);
  }
});

/* Token / Session buttons */
setTokenBtn.addEventListener('click', showTokenModal);

setSessionBtn.addEventListener('click', ()=>{
  if(confirm('Use sessionStorage? Your token will clear when you close the tab.')){
    sessionStorage.setItem(SESSION_ONLY_KEY,'1');
    const localTok = localStorage.getItem(TOKEN_KEY);
    if(localTok){ 
      sessionStorage.setItem(TOKEN_KEY, localTok); 
      localStorage.removeItem(TOKEN_KEY); 
    }
    tokenOk();
  }
});

clearTokenBtn.addEventListener('click', ()=>{
  localStorage.removeItem(TOKEN_KEY);
  sessionStorage.removeItem(TOKEN_KEY);
  sessionStorage.removeItem(SESSION_ONLY_KEY);
  tokenOk("No token");
});

/* Token modal event listeners */
closeTokenModal.addEventListener('click', hideTokenModal);
cancelTokenBtn.addEventListener('click', hideTokenModal);
saveTokenBtn.addEventListener('click', saveTokenFromModal);

// Close modal when clicking outside of it
tokenModal.addEventListener('click', (e) => {
  if (e.target === tokenModal) {
    hideTokenModal();
  }
});

// Handle Escape key to close modal
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && tokenModal.style.display === 'flex') {
    hideTokenModal();
  }
});

/* Config bind + load */
(function initCfg(){
  const cfg = loadCfg();
  cfgOwner.value = cfg.owner;
  cfgRepo.value = cfg.repo;
  cfgBranch.value = cfg.branch;
  cfgDocuments.value = cfg.documentsPath;
})();

[cfgOwner,cfgRepo,cfgBranch,cfgDocuments].forEach(el=>{
  el.addEventListener('change', ()=> saveCfg(currentCfg()));
});

/* Init */
tokenOk();
refreshBtn.addEventListener('click', refreshDocumentsList);
refreshDocumentsList();

/* Initial message */
log("Uganda Legal Documents Admin Panel initialized");
log("Set your GitHub token to start managing documents.");
</script>
</body>
</html>
